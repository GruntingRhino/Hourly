generator client {
  provider      = "prisma-client-js"
  output        = "../../node_modules/.prisma/client"
  binaryTargets = ["native", "rhel-openssl-1.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Users & Identity ───────────────────────────────────────────

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String
  phone         String?
  bio           String?
  avatarUrl     String?
  role          String    // DISTRICT_ADMIN, SCHOOL_ADMIN, TEACHER, STUDENT, ORG_ADMIN
  status        String    @default("ACTIVE") // ACTIVE, SUSPENDED, REVOKED
  emailVerified Boolean   @default(false)
  emailVerificationToken String?
  emailVerificationExpires DateTime?
  passwordResetToken String?
  passwordResetExpires DateTime?
  socialLinks              String?   // JSON string (for student social profiles)
  notificationPreferences  String?   // JSON: {hourApproval:{email,inApp}, hourRemoval:{email,inApp}, eventChange:{email,inApp}, orgRequest:{email,inApp}}
  messagePreferences       String?   // JSON: {allowFrom:"EVERYONE"|"ORGS_ONLY"|"ADMINS_ONLY", profileVisibility:"EVERYONE"|"SCHOOL"|"PRIVATE"}
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Student-specific
  age           Int?
  grade         String?
  classroomId   String?
  classroom     Classroom? @relation("ClassroomStudents", fields: [classroomId], references: [id])

  // Staff school association (SCHOOL_ADMIN, TEACHER, DISTRICT_ADMIN)
  schoolId      String?
  school        School?   @relation("SchoolStaff", fields: [schoolId], references: [id])

  // Organization-specific (ORG_ADMIN)
  organizationId String?
  organization   Organization? @relation("OrgMembers", fields: [organizationId], references: [id])

  // Relations
  signups              Signup[]
  serviceSessions      ServiceSession[]
  sentMessages         Message[]        @relation("SentMessages")
  receivedMessages     Message[]        @relation("ReceivedMessages")
  notifications        Notification[]
  auditLogs            AuditLog[]       @relation("AuditActor")
  savedOpportunities   SavedOpportunity[]
  createdSchools       School[]         @relation("SchoolCreator")
  taughtClassrooms     Classroom[]      @relation("ClassroomTeacher")
}

// ─── Schools ────────────────────────────────────────────────────

model School {
  id               String   @id @default(cuid())
  name             String
  domain           String?
  verified         Boolean  @default(false)
  createdById      String
  createdBy        User     @relation("SchoolCreator", fields: [createdById], references: [id])
  requiredHours    Float    @default(40)
  verificationStandard String @default("OPEN")
  zipCodes         String?  // JSON array of zip codes
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  staff            User[]               @relation("SchoolStaff")
  classrooms       Classroom[]
  approvedOrgs     SchoolOrganization[]
  groups           StudentGroup[]
}

// ─── Classrooms ─────────────────────────────────────────────────

model Classroom {
  id          String   @id @default(cuid())
  name        String
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id])
  teacherId   String
  teacher     User     @relation("ClassroomTeacher", fields: [teacherId], references: [id])
  inviteCode  String   @unique
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  students    User[]   @relation("ClassroomStudents")
}

// ─── Organizations ──────────────────────────────────────────────

model Organization {
  id           String   @id @default(cuid())
  name         String
  email        String
  phone        String?
  description  String?
  website      String?
  socialLinks  String?  // JSON string
  avatarUrl    String?
  status       String   @default("PENDING") // PENDING, APPROVED, REJECTED, SUSPENDED
  zipCodes     String?  // JSON array of zip codes
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  members      User[]              @relation("OrgMembers")
  opportunities Opportunity[]
  schoolApprovals SchoolOrganization[]
}

// ─── School <-> Organization approval ───────────────────────────

model SchoolOrganization {
  id             String       @id @default(cuid())
  schoolId       String
  organizationId String
  status         String       @default("PENDING") // PENDING, APPROVED, REJECTED
  approvedAt     DateTime?
  school         School       @relation(fields: [schoolId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id])
  createdAt      DateTime     @default(now())

  @@unique([schoolId, organizationId])
}

// ─── Student Groups (for school admin) ──────────────────────────

model StudentGroup {
  id        String   @id @default(cuid())
  name      String
  schoolId  String
  school    School   @relation(fields: [schoolId], references: [id])
  createdAt DateTime @default(now())

  members   StudentGroupMember[]
}

model StudentGroupMember {
  id        String       @id @default(cuid())
  groupId   String
  studentId String
  group     StudentGroup @relation(fields: [groupId], references: [id])
  createdAt DateTime     @default(now())

  @@unique([groupId, studentId])
}

// ─── Opportunities ──────────────────────────────────────────────

model Opportunity {
  id              String       @id @default(cuid())
  title           String
  description     String
  tags            String?      // JSON array string
  location        String
  address         String?
  latitude        Float?
  longitude       Float?
  date            DateTime
  startTime       String       // "10:00 AM"
  endTime         String       // "2:00 PM"
  durationHours   Float
  capacity        Int
  ageRequirement  Int?
  gradeRequirement String?
  isRecurring     Boolean      @default(false)
  recurringPattern String?     // JSON
  customFields    String?      // JSON: [{label:string, value:string}]
  status          String       @default("ACTIVE") // ACTIVE, CANCELLED, COMPLETED
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id])
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  signups         Signup[]
  serviceSessions ServiceSession[]
  savedBy         SavedOpportunity[]
}

// ─── Signups ────────────────────────────────────────────────────

model Signup {
  id              String      @id @default(cuid())
  userId          String
  opportunityId   String
  status          String      @default("CONFIRMED") // CONFIRMED, WAITLISTED, CANCELLED, NO_SHOW
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  user            User        @relation(fields: [userId], references: [id])
  opportunity     Opportunity @relation(fields: [opportunityId], references: [id])

  @@unique([userId, opportunityId])
}

// ─── Saved/Bookmarked Opportunities ─────────────────────────────

model SavedOpportunity {
  id              String      @id @default(cuid())
  userId          String
  opportunityId   String
  status          String      @default("SAVED") // SAVED, SKIPPED, DISCARDED
  createdAt       DateTime    @default(now())

  user            User        @relation(fields: [userId], references: [id])
  opportunity     Opportunity @relation(fields: [opportunityId], references: [id])

  @@unique([userId, opportunityId])
}

// ─── Service Sessions (attendance records) ──────────────────────

model ServiceSession {
  id              String      @id @default(cuid())
  userId          String
  opportunityId   String
  checkInTime     DateTime?
  checkOutTime    DateTime?
  totalHours      Float?
  status          String      @default("COMMITTED") // COMMITTED, PENDING_VERIFICATION, VERIFIED, REJECTED, PENDING_CHECKIN, CHECKED_IN, CHECKED_OUT
  verificationStatus String   @default("PENDING") // PENDING, APPROVED, REJECTED
  verifiedBy      String?
  verifiedAt      DateTime?
  rejectionReason String?

  // Verification submission fields
  signatureType     String?   // "DRAWN" or "FILE"
  signatureData     String?   // Base64 eSignature data (for DRAWN type)
  signatureFileUrl  String?   // File path for uploaded signature (for FILE type)
  signatureFileName String?   // Original filename
  submittedAt       DateTime? // When verification was submitted

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  user            User        @relation(fields: [userId], references: [id])
  opportunity     Opportunity @relation(fields: [opportunityId], references: [id])
  auditLogs       AuditLog[]

  @@unique([userId, opportunityId])
}

// ─── Audit Log (immutable) ──────────────────────────────────────

model AuditLog {
  id              String         @id @default(cuid())
  action          String         // CHECK_IN, CHECK_OUT, APPROVE, REJECT, OVERRIDE, etc.
  details         String?        // JSON
  actorId         String
  sessionId       String?
  createdAt       DateTime       @default(now())

  actor           User           @relation("AuditActor", fields: [actorId], references: [id])
  session         ServiceSession? @relation(fields: [sessionId], references: [id])
}

// ─── Messages ───────────────────────────────────────────────────

model Message {
  id          String   @id @default(cuid())
  subject     String?
  body        String
  senderId    String
  receiverId  String
  priority    Boolean  @default(false)
  read        Boolean  @default(false)
  createdAt   DateTime @default(now())

  sender      User     @relation("SentMessages", fields: [senderId], references: [id])
  receiver    User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
}


// ─── Notifications ──────────────────────────────────────────────

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // SIGNUP_CONFIRMED, EVENT_REMINDER, VERIFICATION_UPDATE, etc.
  title     String
  body      String
  read      Boolean  @default(false)
  data      String?  // JSON
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])
}
